# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

variables:
  - group: docker
  - name: versionBuilder
    value: '2.0'
  - name: addonName
    value: 'openvpn-monitor'

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      # Write your PowerShell commands here.
      $file = "$(Build.SourcesDirectory)/config.json"
      $json = (Get-Content -Path $file | Out-String | ConvertFrom-Json)
      Write-Host "$json"
      $version = $json.version
      Write-Host "##vso[task.setvariable variable=version]$version"
      Write-Host "Version: $version"
  displayName: 'Read version from config file'
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: sudo docker login -u $(dockerUsername) -p $(dockerPassword)
  displayName: 'Docker hub login'
- task: PowerShell@2
  inputs:
    targetTYpe: 'inline'
    script: sudo docker pull homeassistant/amd64-builder:$(versionBuilder)
  displayName: 'Install Builder'
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      sudo docker run --rm --privileged \
        -v ~/.docker:/root/.docker \
        -v /run/docker.sock:/run/docker.sock:rw -v $(pwd):/data:ro \
        homeassistant/amd64-builder:$(versionBuilder) \
        --addon --all -t /data/${{ parameters.addonName }} \
        --docker-hub homeassistant --docker-hub-check
  displayName: 'Build ${{ parameters.addonName }}'
